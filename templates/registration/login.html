{% extends "base.html" %}
{% load static %}

{% block title %}登录{% endblock %}
{% block style %}
    <link href="{% static "css/bootstrap-icons.min.css" %}" rel="stylesheet">
    <style>
        /* 1. 全局重置：强制占满屏幕，去除所有默认边距 */
        html, body {
            height: 100vh;      /* 强制高度为视口高度 */
            width: 100vw;       /* 强制宽度为视口宽度 (关键修改) */
            margin: 0 !important;  /* 强制去除外边距 (关键修改) */
            padding: 0 !important; /* 强制去除内边距 */
            overflow: hidden;   /* 禁止出现滚动条，防止因滚动条导致背景错位 */
            box-sizing: border-box;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* 背景图设置 */
            background: linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.8)),
                        url("{% static 'img/login/loginBackground.png' %}") no-repeat center center fixed;
            /* background-image: url("{% static 'img/login/loginBackground.png' %}"); */
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 100% 100%; /* 背景图略微放大以覆盖整个视口 */
            background-attachment: fixed; /* 背景固定 */
        }
        
        /* 登录框样式 */
        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            transition: all 0.3s ease;
            z-index: 1000;
            /* 确保登录框在 flex 布局中不会过大 */
            margin: auto; 
        }

        .login-container:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        /* 其他样式保持不变 */
        .form-signin { width: 100%; }
        .logo-img { width: 80px; height: auto; margin-bottom: 1.5rem; }
        .form-floating { position: relative; margin-bottom: 1.5rem; }
        .password-toggle {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: #6c757d; transition: color 0.2s;
        }
        .password-toggle:hover { color: #0d6efd; }
        .btn-login {
            background-color: #0d6efd; border: none; padding: 0.75rem;
            font-weight: 600; transition: all 0.3s; color: white;
        }
        .btn-login:hover {
            background-color: #0b5ed7; transform: translateY(-2px); color: white;
        }
        .form-control { padding: 1rem 0.75rem; border-radius: 8px; }
        .form-control:focus { box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
    </style>
{% endblock %}

{% block main %}
<div class="login-container">
    <main class="form-signin">
        <form method="post" action="{% url 'login' %}">
            {% csrf_token %}
            <img class="logo-img mx-auto d-block" style="width: 80%;"  src="{% static 'img/login/AIshuzhiyanpei.jpg' %}" alt="系统logo">
            <!-- <h1 class="h3 mb-4 text-center fw-normal">普诺瞳 AI</h1> -->

            <div class="form-floating">
                <input type="text" class="form-control" id="floatingInput" placeholder="用户名" name="username" required value="{{ form.username.value|default:'admin' }}">
                <label for="floatingInput">账号</label>
            </div>
            <div class="form-floating">
                <input type="password" class="form-control" id="floatingPassword" placeholder="密码" name="password" required value="">
                <label for="floatingPassword">密码</label>
                <i class="bi bi-eye-fill password-toggle" onclick="togglePassword()"></i>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">记住我</label>
                </div>
{#                <a href="#" class="text-decoration-none">忘记密码?</a>#}
            </div>

            <button class="w-100 btn btn-lg btn-login" type="submit">登录</button>
        </form>
    </main>
</div>
{% endblock %}

{% block javascript %}
<script>
    function togglePassword() {
        const passwordInput = document.getElementById('floatingPassword');
        const toggleIcon = document.querySelector('.password-toggle');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.replace('bi-eye-fill', 'bi-eye-slash-fill');
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.replace('bi-eye-slash-fill', 'bi-eye-fill');
        }
    }

    // 表单提交前保存密码到sessionStorage
    document.querySelector('form').addEventListener('submit', function() {
        sessionStorage.setItem('loginPassword', document.getElementById('floatingPassword').value);
    });

    // 页面加载时处理
    window.onload = function() {
        const passwordInput = document.getElementById('floatingPassword');
        const hasError = {% if form.errors or form.non_field_errors %}true{% else %}false{% endif %};

        if (hasError) {
            // 登录失败：从sessionStorage恢复密码，并显示弹窗
            const savedPassword = sessionStorage.getItem('loginPassword');
            if (savedPassword) {
                passwordInput.value = savedPassword;
            }
            alert('账号或密码错误，请重新输入');
        } else {
            // 首次加载：设置默认密码
            passwordInput.value = '123456';
            sessionStorage.removeItem('loginPassword');
        }
    }
</script>
{% endblock %}