<!-- ä¿®æ”¹ä¿¡æ¯å¼¹çª— -->
<div class="modal modal-blur fade" id="editModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-header">
                <h5 class="modal-title">ä¿®æ”¹æ‚£è€…ä¿¡æ¯</h5>
            </div>
            <form action="{% url 'patient_update' pk=0 %}" method="post">
                {% csrf_token %}
                <input type="hidden" id="edit-id" name="id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label require" for="edit-name">
                                    å§“å<span class="text-danger">*</span>
                                </label>
                                <input id="edit-name" type="text" class="form-control" name="name" placeholder="è¯·è¾“å…¥æ‚£è€…å§“å">
                                <div class="invalid-feedback">è¯·è¾“å…¥æ‚£è€…å§“å</div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label require" for="edit-birth-date">
                                    å‡ºç”Ÿæ—¥æœŸ<span class="text-danger">*</span>
                                </label>
                                <input id="edit-birth-date" type="date" class="form-control" name="birth_date" max="9999-12-31">
                                <div class="invalid-feedback">è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label d-block" for="edit-gender">
                                    æ€§åˆ« <span class="text-danger">*</span>
                                </label>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="gender" id="edit-gender-male" value="ç”·" required>
                                    <label class="btn btn-outline-primary" for="edit-gender-male">ç”·</label>
                                
                                    <input type="radio" class="btn-check" name="gender" id="edit-gender-female" value="å¥³">
                                    <label class="btn btn-outline-primary" for="edit-gender-female">å¥³</label>
                                </div>
                            </div>
                        </div>
    
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label" for="edit-phone">
                                    è”ç³»æ–¹å¼ 
                                </label>
                                <input id="edit-phone" 
                                       type="tel" 
                                       name="phone" 
                                       class="form-control" 
                                       pattern="1[3-9]\d{9}" 
                                       placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·">
                                <div class="invalid-feedback">è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label" for="edit-age">
                                    å¹´é¾„ 
                                </label>
                                <input id="edit-age" 
                                       type="number" 
                                       name="age" 
                                       class="form-control" 
                                       min="0" 
                                       max="120" 
                                       placeholder="æ ¹æ®å‡ºç”Ÿæ—¥æœŸè‡ªåŠ¨è®¡ç®—"
                                       readonly>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label" for="edit-medical-record-number">
                                    ç—…å†å·
                                </label>
                                <input id="edit-medical-record-number" 
                                       type="text" 
                                       name="medical_record_number" 
                                       class="form-control"
                                       placeholder="å¯é€‰å¡«å†™ç—…å†å·">
                             </div>
                        </div>
                    </div>
                </div>    
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editModal = document.getElementById('editModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            
            // è·å–æ•°æ®
            const id = button.getAttribute('data-id');
            const name = button.getAttribute('data-name');
            const phone = button.getAttribute('data-phone');
            const gender = button.getAttribute('data-gender');
            const medicalRecordNumber = button.getAttribute('data-medical-record-number') || '';
            
            // --- ğŸ“… å…³é”®ä¿®å¤ï¼šå¤„ç†æ—¥æœŸæ ¼å¼ ---
            let rawDate = button.getAttribute('data-create-date');
            let formattedDate = '';

            if (rawDate) {
                // å°è¯•å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¥æœŸå¯¹è±¡
                const dateObj = new Date(rawDate);
                if (!isNaN(dateObj.getTime())) {
                    // æ‰‹åŠ¨æ‹¼æ¥æˆ YYYY-MM-DD æ ¼å¼
                    // æ³¨æ„ï¼štoISOString() ä¼šè½¬ä¸º UTCï¼Œå¯èƒ½å¯¼è‡´æ—¥æœŸå°‘ä¸€å¤©
                    // è¿™é‡Œä½¿ç”¨æœ¬åœ°æ—¶é—´æ–¹æ³•
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    formattedDate = `${year}-${month}-${day}`;
                }
            }
            // -------------------------------

            // å¡«å……è¡¨å•
            const form = editModal.querySelector('form');
            form.action = "{% url 'patient_update' pk=0 %}".replace('0', id);

            editModal.querySelector('#edit-id').value = id;
            editModal.querySelector('#edit-name').value = name;
            editModal.querySelector('#edit-phone').value = phone;
            
            // æ€§åˆ«å•é€‰
            editModal.querySelector('#edit-gender-male').checked = (gender === 'ç”·');
            editModal.querySelector('#edit-gender-female').checked = (gender === 'å¥³');
            
            // å¡«å……æ—¥æœŸï¼ˆä½¿ç”¨å¤„ç†è¿‡çš„ formattedDateï¼‰
            const birthInput = editModal.querySelector('#edit-birth-date');
            if (birthInput) {
                birthInput.value = formattedDate;
            }
            
            editModal.querySelector('#edit-medical-record-number').value = medicalRecordNumber;

            // è‡ªåŠ¨è®¡ç®—å¹´é¾„
            const ageInput = editModal.querySelector('#edit-age');
            function updateAge() {
                if (birthInput.value) {
                    const today = new Date();
                    const birthDate = new Date(birthInput.value);
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    ageInput.value = age;
                } else {
                    ageInput.value = '';
                }
            }
            
            // æ‰“å¼€æ—¶è®¡ç®—ä¸€æ¬¡ï¼Œå˜æ›´æ—¶è®¡ç®—ä¸€æ¬¡
            updateAge();
            birthInput.addEventListener('change', updateAge);
        });
    }
});
</script>
{% endblock %}
